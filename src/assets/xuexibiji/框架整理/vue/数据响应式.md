# vue2 çš„æºç åˆ†æ

å…ˆä¸Šä¸€å¼ å›¾æ¥é•‡æ¥¼

![vue2å“åº”å¼æ•°æ®](../../img/vue2.png)

[å…·ä½“æºç åˆ†æ](https://www.processon.com/view/link/5d9192cce4b0ca6e052c9c3a)

## å…ˆæ‹ä¸€æ¡çº¿

ä»¥vueè¿è¡Œçš„è¿‡ç¨‹ä¸ºåˆ‡å…¥ç‚¹

- å°†vueæ–‡ä»¶åˆ†å—ç¼–è¯‘ï¼Œtemplateã€scriptã€style
  - template æ ¹æ®Nodeå±æ€§å’Œæ­£åˆ™åŒ¹é…ç”ŸæˆASTï¼Œè§£æå‡ºæŒ‡ä»¤directiveï¼Œä¸€ä¸ªæŒ‡ä»¤å¯¹åº”ä¸€ä¸ªwatcher
  - script `new Vue` å°†dataä»£ç†åˆ°vmä¸Šï¼Œå®ä¾‹åŒ–Observerï¼Œç”Ÿæˆ`getter`ã€`setter`
  - åœ¨`getter`ä¸­å°†å¯¹åº”çš„watcheræ·»åŠ åˆ°depä¾èµ–æ”¶é›†ä¸­ï¼Œ
  - åœ¨`setter`ä¸­æ‰§è¡Œdepä¸­å¯¹åº”ä¾èµ–çš„watcherçš„update
  - ç»„ä»¶æœ¬è´¨ä¸Šä¹Ÿæ˜¯ `new Vue`
- å½“æ•°æ®æ”¹å˜æ—¶ï¼Œè§¦å‘`setter`ï¼Œæ‰§è¡Œdepä¸­å¯¹åº”ä¾èµ–çš„watcherçš„update
  - é€šè¿‡è°ƒåº¦ç®—æ³•æ‰§è¡Œpatch
  - DOM diffå°†éœ€è¦æ›´æ–°çš„VNodeæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
  - æ›´æ–°æ¸²æŸ“åˆ°é¡µé¢ä¸Š

## directive

vue çš„ directive åŒ…å«

- v-model
- v-for
- v-show domå…ƒç´ æ˜¯å¦æ˜¾ç¤º
- v-if domå…ƒç´ æ˜¯å¦å­˜åœ¨
- v-else
- v-else-if
- v-bind ç®€å†™ `:`
- v-on ç®€å†™ `@`
- v-text
- v-html
- v-once åªæ¸²æŸ“å…ƒç´ å’Œç»„ä»¶ä¸€æ¬¡
- v-cloak é˜²é—ªçƒï¼Œè¿™ä¸ªæŒ‡ä»¤ä¿æŒåœ¨å…ƒç´ ä¸Šç›´åˆ°å…³è”å®ä¾‹ç»“æŸç¼–è¯‘ï¼Œé˜²æ­¢åˆ·æ–°é¡µé¢ï¼Œç½‘é€Ÿæ…¢çš„æƒ…å†µä¸‹å‡ºç°{{ message }}ç­‰æ•°æ®æ ¼å¼
- v-pre  æŠŠæ ‡ç­¾å†…éƒ¨çš„å…ƒç´ åŸä½è¾“å‡ºï¼Œè·³è¿‡è¿™ä¸ªå…ƒç´ å’Œå®ƒçš„å­å…ƒç´ çš„ç¼–è¯‘è¿‡ç¨‹

```javascript
Vue.directive('my-directive', {
  bind: function () {},//åªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ç¬¬ä¸€æ¬¡ç»‘å®šåˆ°å…ƒç´ æ—¶è°ƒç”¨ã€‚åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œä¸€æ¬¡æ€§çš„åˆå§‹åŒ–è®¾ç½®ã€‚
  inserted: function () {},//è¢«ç»‘å®šå…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹æ—¶è°ƒç”¨ (ä»…ä¿è¯çˆ¶èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†ä¸ä¸€å®šå·²è¢«æ’å…¥æ–‡æ¡£ä¸­)ã€‚
  update: function () {},//æ‰€åœ¨ç»„ä»¶çš„ VNode æ›´æ–°æ—¶è°ƒç”¨ï¼Œä½†æ˜¯å¯èƒ½å‘ç”Ÿåœ¨å…¶å­ VNode æ›´æ–°ä¹‹å‰ã€‚æŒ‡ä»¤çš„å€¼å¯èƒ½å‘ç”Ÿäº†æ”¹å˜ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ã€‚
  componentUpdated: function () {},//æŒ‡ä»¤æ‰€åœ¨ç»„ä»¶çš„ VNode åŠå…¶å­ VNode å…¨éƒ¨æ›´æ–°åè°ƒç”¨ã€‚
  unbind: function () {}//åªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘æ—¶è°ƒç”¨ã€‚
})
```

## htmlæ¨¡ç‰ˆç¼–è¯‘

ç¼–è¯‘htmlæ¨¡ç‰ˆæ–¹æ³•ï¼Œä¸¾ä¸ªæ —å­ğŸŒ°

```html
<ul :class="bindCls" class="list" v-if="isShow">
    <li v-for="(item,index) in data" @click="clickItem(index)">{{item}}:{{index}}</li>
</ul>
```

å¦‚ä¸Šçš„æ¨¡æ¿å¤§è‡´ä¼šç”Ÿæˆå¦‚ä¸‹çš„ASTæ ‘

```javascript
ast = {
  'type': 1,
  'tag': 'ul',
  'attrsList': [],
  'attrsMap': {
    ':class': 'bindCls',
    'class': 'list',
    'v-if': 'isShow'
  },
  'if': 'isShow',
  'ifConditions': [{
    'exp': 'isShow',
    'block': // ul ast element
  }],
  'parent': undefined,
  'plain': false,
  'staticClass': 'list',
  'classBinding': 'bindCls',
  'children': [{
    'type': 1,
    'tag': 'li',
    'attrsList': [{
      'name': '@click',
      'value': 'clickItem(index)'
    }],
    'attrsMap': {
      '@click': 'clickItem(index)',
      'v-for': '(item,index) in data'
     },
    'parent': // ul ast element
    'plain': false,
    'events': {
      'click': {
        'value': 'clickItem(index)'
      }
    },
    'hasBindings': true,
    'for': 'data',
    'alias': 'item',
    'iterator1': 'index',
    'children': [
      'type': 2,
      'expression': '_s(item)+":"+_s(index)'
      'text': '{{item}}:{{index}}',
      'tokens': [
        {'@binding':'item'},
        ':',
        {'@binding':'index'}
      ]
    ]
  }]
}
```

æ•´ä½“æ¥è¯´å®ƒçš„é€»è¾‘å°±æ˜¯å¾ªç¯è§£æ template ï¼Œç”¨æ­£åˆ™åšå„ç§åŒ¹é…ï¼Œå¯¹äºä¸åŒæƒ…å†µåˆ†åˆ«è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œç›´åˆ°æ•´ä¸ª template è¢«è§£æå®Œæ¯•ã€‚

åŒ¹é…çš„è¿‡ç¨‹ä¸­ä¸»è¦åˆ©ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¦‚ä¸‹ï¼š

```javascript
const attribute = /^\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/
const ncname = '[a-zA-Z_][\\w\\-\\.]*'
const qnameCapture = `((?:${ncname}\\:)?${ncname})`
const startTagOpen = new RegExp(`^<${qnameCapture}`)
const startTagClose = /^\s*(\/?)>/
const endTag = new RegExp(`^<\\/${qnameCapture}[^>]*>`)
const doctype = /^<!DOCTYPE [^>]+>/i
const comment = /^<!\--/
const conditionalComment = /^<!\[/
```

ç”ŸæˆASTå…ƒç´ ï¼Œå¹¶æ·»åŠ äº† namespaceï¼Œå…¶ä¸­ï¼Œ

- type è¡¨ç¤º AST å…ƒç´ ç±»å‹,æ–‡æœ¬æ„é€ çš„ AST å…ƒç´ æœ‰ 2 ç§ç±»å‹ï¼Œä¸€ç§æ˜¯æœ‰è¡¨è¾¾å¼çš„ï¼Œtype ä¸º 2ï¼Œä¸€ç§æ˜¯çº¯æ–‡æœ¬ï¼Œtype ä¸º 3ã€‚
- tag è¡¨ç¤ºæ ‡ç­¾åï¼Œ
- attrsList è¡¨ç¤ºå±æ€§åˆ—è¡¨ï¼Œ
- attrsMap è¡¨ç¤ºå±æ€§æ˜ å°„è¡¨ï¼Œ
- parent è¡¨ç¤ºçˆ¶çš„ AST å…ƒç´ ï¼Œ
- children è¡¨ç¤ºå­ AST å…ƒç´ é›†åˆã€‚ç„¶åå¤„ç†ç›¸åº”çš„æŒ‡ä»¤

```javascript
processPre(element)
processRawAttrs(element)
// structural directives
processFor(element)
processIf(element)
processOnce(element)
// element-scope stuff
processElement(element, options)
...
```

å› ä¸ºæˆ‘ä»¬çŸ¥é“ Vue æ˜¯æ•°æ®é©±åŠ¨ï¼Œæ˜¯å“åº”å¼çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ¨¡æ¿å¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½æ˜¯å“åº”å¼çš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ•°æ®æ˜¯é¦–æ¬¡æ¸²æŸ“åå°±æ°¸è¿œä¸ä¼šå˜åŒ–çš„ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®ç”Ÿæˆçš„ DOM ä¹Ÿä¸ä¼šå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ patch çš„è¿‡ç¨‹è·³è¿‡å¯¹ä»–ä»¬çš„æ¯”å¯¹ã€‚

æ‰€ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå¯ä»¥æŠŠä¸€äº› AST èŠ‚ç‚¹ä¼˜åŒ–æˆé™æ€èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ•´ä¸ª optimize çš„è¿‡ç¨‹å®é™…ä¸Šå°±å¹² 2 ä»¶äº‹æƒ…ï¼Œ`markStatic(root)` æ ‡è®°é™æ€èŠ‚ç‚¹ ï¼Œ`markStaticRoots(root, false)` æ ‡è®°é™æ€æ ¹ã€‚

æŠŠæ•´ä¸ª AST æ ‘ä¸­çš„æ¯ä¸€ä¸ª AST å…ƒç´ èŠ‚ç‚¹æ ‡è®°äº† `static` å’Œ `staticRoot`

å¯¹ä¸€ä¸ª AST å…ƒç´ èŠ‚ç‚¹æ˜¯å¦æ˜¯é™æ€çš„åˆ¤æ–­

- å¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œå°±æ˜¯éé™æ€ï¼›
- å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œå°±æ˜¯é™æ€ï¼›å¯¹äºä¸€ä¸ªæ™®é€šå…ƒç´ ï¼Œ
- å¦‚æœæœ‰ pre å±æ€§ï¼Œé‚£ä¹ˆå®ƒä½¿ç”¨äº† v-pre æŒ‡ä»¤ï¼Œæ˜¯é™æ€ï¼Œ
- å¦åˆ™è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
  - æ²¡æœ‰ä½¿ç”¨ v-ifã€v-forï¼Œæ²¡æœ‰ä½¿ç”¨å…¶å®ƒæŒ‡ä»¤ï¼ˆä¸åŒ…æ‹¬ v-onceï¼‰ï¼Œ
  - éå†…ç½®ç»„ä»¶ï¼Œæ˜¯å¹³å°ä¿ç•™çš„æ ‡ç­¾ï¼Œ
  - éå¸¦æœ‰ v-for çš„ template æ ‡ç­¾çš„ç›´æ¥å­èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§çš„ key éƒ½æ»¡è¶³é™æ€ keyï¼›

å¯¹äºæœ‰èµ„æ ¼æˆä¸º staticRoot çš„èŠ‚ç‚¹ï¼Œé™¤äº†æœ¬èº«æ˜¯ä¸€ä¸ªé™æ€èŠ‚ç‚¹å¤–ï¼Œå¿…é¡»æ»¡è¶³æ‹¥æœ‰ childrenï¼Œå¹¶ä¸” children ä¸èƒ½åªæ˜¯ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹

æœ€åä¸€æ­¥å°±æ˜¯æŠŠä¼˜åŒ–åçš„ AST æ ‘è½¬æ¢æˆå¯æ‰§è¡Œçš„ä»£ç 

ä¸Šé¢çš„ğŸŒ°ç”Ÿæˆçš„renderä»£ç å¦‚ä¸‹

```javascript
with(this){
  return (isShow) ?
    _c('ul', {
        staticClass: "list",
        class: bindCls
      },
      _l((data), function(item, index) {
        return _c('li', {
          on: {
            "click": function($event) {
              clickItem(index)
            }
          }
        },
        [_v(_s(item) + ":" + _s(index))])
      })
    ) : _e()
}
```

å…¶ä¸­

```javascript
export function installRenderHelpers (target: any) {
  target._o = markOnce
  target._n = toNumber
  target._s = toString
  target._l = renderList
  target._t = renderSlot
  target._q = looseEqual
  target._i = looseIndexOf
  target._m = renderStatic
  target._f = resolveFilter
  target._k = checkKeyCodes
  target._b = bindObjectProps
  target._v = createTextVNode
  target._e = createEmptyVNode
  target._u = resolveScopedSlots
  target._g = bindObjectListeners
}
```

## å“åº”å¼æ•°æ®

Vue 2.x åˆ©ç”¨ Object.defineProperty()ï¼Œå¹¶ä¸”æŠŠå†…éƒ¨è§£è€¦ä¸º Observer, Dep, å¹¶ä½¿ç”¨ Watcher ç›¸è¿,ä¸èƒ½å…¼å®¹ IE8 åŠä»¥ä¸‹æµè§ˆå™¨
Vue åœ¨ 3.x ç‰ˆæœ¬ä¹‹åæ”¹ç”¨ Proxy è¿›è¡Œå®ç°, IE11 ä¹Ÿ ä¸èƒ½å…¼å®¹

æœ¬æ–‡åªå¯¹Vue 2.xçš„å“åº”å¼æ•°æ®åŸç†è¿›è¡Œåˆ†æ

åœ¨ Vue çš„åˆå§‹åŒ–é˜¶æ®µï¼Œ_init æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œ initState(vm) æ–¹æ³•ï¼Œå¯¹ propsã€methodsã€dataã€computed å’Œ wathcer ç­‰å±æ€§åšäº†åˆå§‹åŒ–æ“ä½œã€‚

initDataä¸­ç»™é VNode çš„å¯¹è±¡ç±»å‹æ•°æ®æ·»åŠ ä¸€ä¸ª Observer

```javascript
/**
 * Observer class that is attached to each observed
 * object. Once attached, the observer converts the target
 * object's property keys into getter/setters that
 * collect dependencies and dispatch updates.
 */
export class Observer {
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that has this object as root $data

  constructor (value: any) {
    this.value = value
    this.dep = new Dep()
    this.vmCount = 0
    def(value, '__ob__', this)
    if (Array.isArray(value)) {
      const augment = hasProto
        ? protoAugment
        : copyAugment
      augment(value, arrayMethods, arrayKeys)
      this.observeArray(value)
    } else {
      this.walk(value)
    }
  }

  /**
   * Walk through each property and convert them into
   * getter/setters. This method should only be called when
   * value type is Object.
   */
  walk (obj: Object) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }

  /**
   * Observe a list of Array items.
   */
  observeArray (items: Array<any>) {
    for (let i = 0, l = items.length; i < l; i++) {
      observe(items[i])
    }
  }
}
```

æœ€åéƒ½æ˜¯æ±‡æ€»åˆ°éå†å¯¹è±¡çš„ key è°ƒç”¨ defineReactive æ–¹æ³•

```javascript
export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  const dep = new Dep()
  ...
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        dep.depend()
        ...
      }
      return value
    },
    set: function reactiveSetter (newVal) {
      const value = getter ? getter.call(obj) : val
      /* eslint-disable no-self-compare */
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      /* eslint-enable no-self-compare */
      ...
      if (setter) {
        setter.call(obj, newVal)
      } else {
        val = newVal
      }
      ...
      dep.notify()
    }
  })
}
```

getter åšçš„äº‹æƒ…æ˜¯ä¾èµ–æ”¶é›†ï¼Œsetter åšçš„äº‹æƒ…æ˜¯æ´¾å‘æ›´æ–°ï¼Œ

**æ³¨æ„ï¼š**

- å½“æˆ‘ä»¬å»ç»™è¿™ä¸ªå¯¹è±¡æ·»åŠ ä¸€ä¸ªæ–°çš„å±æ€§çš„æ—¶å€™ï¼Œæ˜¯ä¸èƒ½å¤Ÿè§¦å‘å®ƒçš„ setter çš„ï¼ŒVue ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®šä¹‰äº†ä¸€ä¸ªå…¨å±€ API `Vue.set` æ–¹æ³•
- Vue ä¹Ÿæ˜¯ä¸èƒ½æ£€æµ‹åˆ°ä»¥ä¸‹å˜åŠ¨çš„æ•°ç»„ï¼š
  - å½“ä½ åˆ©ç”¨æ–°çš„ç´¢å¼•ç›´æ¥è®¾ç½®ä¸€ä¸ªé¡¹æ—¶ï¼Œä¾‹å¦‚ï¼švm.items[indexOfItem] = newValueï¼Œå¯ä»¥ä½¿ç”¨ï¼šVue.set(example1.items, indexOfItem, newValue)ï¼›
  - å½“ä½ ä¿®æ”¹æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œä¾‹å¦‚ï¼švm.items.length = newLengthï¼Œå¯ä»¥ä½¿ç”¨ vm.items.splice(newLength)ã€‚

åœ¨`defineReactive`ä¸­é¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ª Dep çš„å®ä¾‹

```javascript
export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array<Watcher>;

  constructor () {
    this.id = uid++
    this.subs = []
  }

  addSub (sub: Watcher) {
    this.subs.push(sub)
  }

  removeSub (sub: Watcher) {
    remove(this.subs, sub)
  }

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    // stabilize the subscriber list first
    const subs = this.subs.slice()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}
```

å®ƒæœ‰ä¸€ä¸ªé™æ€å±æ€§ targetï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€ Watcher,åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå…¨å±€çš„ Watcher è¢«è®¡ç®—ï¼Œå¦å¤–å®ƒçš„è‡ªèº«å±æ€§ subs ä¹Ÿæ˜¯ Watcher çš„æ•°ç»„ã€‚

å½“æˆ‘ä»¬åœ¨ç»„ä»¶ä¸­å¯¹å“åº”çš„æ•°æ®åšäº†ä¿®æ”¹ï¼Œå°±ä¼šè§¦å‘ setter çš„é€»è¾‘ï¼Œæœ€åè°ƒç”¨ dep.notify() æ–¹æ³•

ä¹Ÿå°±æ˜¯éå†æ‰€æœ‰çš„ subsï¼Œä¹Ÿå°±æ˜¯ Watcher çš„å®ä¾‹æ•°ç»„ï¼Œç„¶åè°ƒç”¨æ¯ä¸€ä¸ª watcher çš„ update æ–¹æ³•

```javascript
class Watcher {
  // ...
  update () {
    /* istanbul ignore else */
    if (this.computed) {
      // A computed property watcher has two modes: lazy and activated.
      // It initializes as lazy by default, and only becomes activated when
      // it is depended on by at least one subscriber, which is typically
      // another computed property or a component's render function.
      if (this.dep.subs.length === 0) {
        // In lazy mode, we don't want to perform computations until necessary,
        // so we simply mark the watcher as dirty. The actual computation is
        // performed just-in-time in this.evaluate() when the computed property
        // is accessed.
        this.dirty = true
      } else {
        // In activated mode, we want to proactively perform the computation
        // but only notify our subscribers when the value has indeed changed.
        this.getAndInvoke(() => {
          this.dep.notify()
        })
      }
    } else if (this.sync) {
      this.run()
    } else {
      queueWatcher(this)
    }
  }
}  
```

å®ƒå¹¶ä¸ä¼šæ¯æ¬¡æ•°æ®æ”¹å˜éƒ½è§¦å‘ watcher çš„å›è°ƒï¼Œè€Œæ˜¯æŠŠè¿™äº› watcher å…ˆæ·»åŠ åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œç„¶ååœ¨ nextTick åæ‰§è¡Œ flushSchedulerQueueã€‚

- ç»„ä»¶çš„æ›´æ–°ç”±çˆ¶åˆ°å­ï¼›å› ä¸ºçˆ¶ç»„ä»¶çš„åˆ›å»ºè¿‡ç¨‹æ˜¯å…ˆäºå­çš„ï¼Œæ‰€ä»¥ watcher çš„åˆ›å»ºä¹Ÿæ˜¯å…ˆçˆ¶åå­ï¼Œæ‰§è¡Œé¡ºåºä¹Ÿåº”è¯¥ä¿æŒå…ˆçˆ¶åå­ã€‚
- ç”¨æˆ·çš„è‡ªå®šä¹‰ watcher è¦ä¼˜å…ˆäºæ¸²æŸ“ watcher æ‰§è¡Œï¼›å› ä¸ºç”¨æˆ·è‡ªå®šä¹‰ watcher æ˜¯åœ¨æ¸²æŸ“ watcher ä¹‹å‰åˆ›å»ºçš„ã€‚
- å¦‚æœä¸€ä¸ªç»„ä»¶åœ¨çˆ¶ç»„ä»¶çš„ watcher æ‰§è¡ŒæœŸé—´è¢«é”€æ¯ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„ watcher æ‰§è¡Œéƒ½å¯ä»¥è¢«è·³è¿‡ï¼Œæ‰€ä»¥çˆ¶ç»„ä»¶çš„ watcher åº”è¯¥å…ˆæ‰§è¡Œã€‚

`next-tick.js`

- ç”³æ˜äº† microTimerFunc å’Œ macroTimerFunc 2 ä¸ªå˜é‡ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”çš„æ˜¯ micro task çš„å‡½æ•°å’Œ macro task çš„å‡½æ•°ã€‚
- å¯¹äº macro task çš„å®ç°ï¼Œ
  - ä¼˜å…ˆæ£€æµ‹æ˜¯å¦æ”¯æŒåŸç”Ÿ setImmediateï¼Œè¿™æ˜¯ä¸€ä¸ªnodeæ”¯æŒçš„ç‰¹æ€§ï¼Œ
  - ä¸æ”¯æŒçš„è¯å†å»æ£€æµ‹æ˜¯å¦æ”¯æŒåŸç”Ÿçš„ MessageChannelï¼Œ
  - å¦‚æœä¹Ÿä¸æ”¯æŒçš„è¯å°±ä¼šé™çº§ä¸º setTimeout 0ï¼›
- è€Œå¯¹äº micro task çš„å®ç°ï¼Œ
  - åˆ™æ£€æµ‹æµè§ˆå™¨æ˜¯å¦åŸç”Ÿæ”¯æŒ Promiseï¼Œ
  - ä¸æ”¯æŒçš„è¯ç›´æ¥æŒ‡å‘ macro task çš„å®ç°ã€‚
  